<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-control: max-age=172800" content="public">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/userRegistration.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Редактирование анкеты</title>
</head>
<body>
    <div class="container">
        <div class="wrapper" style="width: 100%;">
            <img src="{{ url_for('static', path='img/backgrounds/blur-back-2.png') }}" style="width: 100%; height: 305px;" alt="">
        </div>
        <main class="app">
            <div class="app__info block_margin">
                <div class="info__title info__title_margin">
                    <h3>Редактирование анкеты</h3>
                </div>
            </div>
            <form class="app__form" onsubmit="sendData(event)" />
                <ul class="form__blocks block_margin">
                    <li class="form__item">
                        <input id="full-name" class="form__field" type="text" name="name" placeholder=" "required>
                        <label for="full-name" class="field__placeholder">Имя и фамилия</label>
                    </li>
                    <li class="form__item">
                        <input id="birth-date-input" class="form__field" type="text" placeholder=" " required>
                        <label for="birth-date-input" class="field__placeholder">Дата рождения</label>
                        <input id="birth-date" type="date" name="birthdate">
                    </li>
                    <li class="form__item">
                        <input id="time-zone" type="text" name="timezone" hidden>
                        <input id="time-zone-input" class="form__field" type="text" placeholder=" ">
                        <label for="time-zone-input" class="field__placeholder">Часовой пояс</label>
                        <ul class="field__selector wrapped">
                            <li class="selector__item" value=-1>Калининград (МСК-1)</li>
                            <li class="selector__item" value=0>Москва (МСК)</li>
                            <li class="selector__item" value=1>Самара (МСК+1)</li>
                            <li class="selector__item" value=2>Екатеринбург (МСК+2).</li>
                            <li class="selector__item" value=3>Омск (МСК+3)</li>
                            <li class="selector__item" value=4>Красноярск (МСК+4)</li>
                            <li class="selector__item" value=5>Иркутск (МСК+5)</li>
                            <li class="selector__item" value=6>Якутск (МСК+6)</li>
                            <li class="selector__item" value=7>Владивосток (МСК+7)</li>
                            <li class="selector__item" value=8>Магадан (МСК+8)</li>
                            <li class="selector__item" value=9>Камчатка (МСК+9)</li>
                        </ul>
                    </li>
                </ul>
                <button class="form__button">Изменить</button>
            </form>
        </main>
    </div>
    <!-- Плагин для маски ввода данных-->
    <script type="text/javascript" src="{{ url_for('static', path='js/inputmask.js') }}"></script>
    <!-- Фильтрация для текстового поля 'часовой пояс'-->
    <script type="text/javascript" src="{{ url_for('static', path='js/update_selector.js') }}"></script>
    <script>

        document.onclick = (event) => {
            document.querySelectorAll(".form__item").forEach((item) => {
                if (event.target === item || item.contains(event.target)) {
                    return
                } else {
                    item.blur();
                }
            })
        }

        /* Инициализация маски для полей: имя, дата */

        const full_name_mask = IMask(document.querySelector("#full-name"), {
            mask: "[" + "a".repeat(20) + "] [" + "a".repeat(20) + "]"
        })

        const birth_date_mask = IMask(document.querySelector("#birth-date-input"), {
            mask: Date,
            pattern: 'DD.MM.YYYY',
            blocks: {
                YYYY: {
                    mask: IMask.MaskedRange,
                    from: 1900,
                    to: 9999
                },
                MM: {
                    mask: IMask.MaskedRange,
                    from: 1,
                    to: 12
                },
                DD: {
                    mask: IMask.MaskedRange,
                    from: 1,
                    to: 31
                },
            }
        })

        /* Создание календаря */

        const date = document.querySelector("#birth-date")
        const date_input = document.querySelector("#birth-date-input")

        date.onchange = () => {
            let [year, month, day] = date.value.split("-")
            date_input.value = `${day}.${month}.${year}`
            birth_date_mask.updateValue()
        }

        date_input.onchange = () => {
            let [day, month, year] = date_input.value.split(".")
            date.value = `${year}-${month}-${day}`
        }

        /* Отправка данных из формы */

        const App = window.Telegram.WebApp;
        const api_url = "{{ host }}"
        const user_id = "{{ user_id }}"

        if (App.initDataUnsafe.user !== undefined) {
            let username = App.initDataUnsafe.user.username
            if (username) {
                document.querySelector("#full-name").value = `${username}`;
                full_name_mask.updateValue()
            }
        }

        function convert_to_string(value) {
            let input = document.querySelector(`.selector__item[value="${value}"]`)
            return input.innerText
        }

        document.querySelector("#full-name").value = "{{ name }}"
        full_name_mask.updateValue()
        if ('{{ birthdate }}') {
            document.querySelector("#birth-date").value = '{{ birthdate }}'
            document.querySelector("#birth-date").onchange()
            birth_date_mask.updateValue()
        }
        document.querySelector('#time-zone-input').value = convert_to_string('{{ timezone }}')
        document.querySelector('#time-zone').value = '{{ timezone }}'


        function sendData(event) {
            event.preventDefault()
            putUser()
            return true
        }

        async function putUser() {
            let url = `${api_url}api/user/${user_id}/`;
            let timezone = document.querySelector("#time-zone").value

            let app_user = App.initDataUnsafe.user
            let account_id = app_user === undefined ? null : app_user.id

            let user = {
                id: user_id,
                name: document.querySelector("#full-name").value,
                birthdate: document.querySelector("#birth-date").value,
                timezone:  timezone !== "" ? parseInt(timezone) : 0,
            };

            await fetch(url, {
                method: 'PUT',
                mode: 'cors',
                headers: {
                    'ngrok-skip-browser-warning': '100',
                    'Content-Type': 'application/json',
                    'accept': 'application/json',
                    'Authorization': btoa(App.initData),
                },
                body: JSON.stringify(user),
            }).then(res => {
                App.close()
            }).catch(err => {
                App.alert("error")
            })
        }

    </script>
</body>
</html>
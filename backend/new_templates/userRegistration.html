<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-control: max-age=172800" content="public">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/userRegistration.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Регистрация</title>
</head>
<body>
    <div class="container">
        <div class="wrapper">
            <img src="{{ url_for('static', path='img/backgrounds/blur-back.png') }}" alt="">
        </div>
        <main class="app">
            <div class="app__illustration block_margin">
                <div class="illustration__image">
                    <img src="{{ url_for('static', path='img/icons/illustration.svg') }}" alt="illustration">
                </div>
            </div>
            <div class="app__info block_margin">
                <div class="info__title info__title_margin">
                    <h3>Регистрация</h3>
                </div>
                <div class="info__content">
                    Пожалуйста, введите данные
                    для регистрации. После этого
                    вы сможете начать сбор
                </div>
            </div>
            <form class="app__form" onsubmit="postUser();return false;">
                <ul class="form__blocks block_margin">
                    <li class="form__item">
                        <input id="full-name" class="form__field" type="text" name="name" placeholder=" "required>
                        <label for="full-name" class="field__placeholder">Имя и фамилия</label>
                    </li>
                    <li class="form__item">
                        <input id="birth-date-input" class="form__field" type="text" placeholder=" " required>
                        <label for="birth-date-input" class="field__placeholder">Дата рождения</label>
                        <input id="birth-date" type="date" name="birthdate" onfocus="this.style.opacity=0" onblur="this.style.opacity=1">
                    </li>
                    <li class="form__item">
                        <input id="time-zone" type="text" name="timezone" hidden>
                        <input id="time-zone-input" class="form__field" type="text" placeholder=" ">
                        <label for="time-zone-input" class="field__placeholder">Часовой пояс</label>
                        <ul class="field__selector wrapped">
                            <li class="selector__item" value=-1>Калининград (МСК-1)</li>
                            <li class="selector__item" value=0>Москва (МСК)</li>
                            <li class="selector__item" value=+1>Самара (МСК+1)</li>
                            <li class="selector__item" value=+2>Екатеринбург (МСК+2).</li>
                            <li class="selector__item" value=+3>Омск (МСК+3)</li>
                            <li class="selector__item" value=+4>Красноярск (МСК+4)</li>
                            <li class="selector__item" value=+5>Иркутск (МСК+5)</li>
                            <li class="selector__item" value=+6>Якутск (МСК+6)</li>
                            <li class="selector__item" value=+7>Владивосток (МСК+7)</li>
                            <li class="selector__item" value=+8>Магадан (МСК+8)</li>
                            <li class="selector__item" value=+9>Камчатка (МСК+9)</li>
                        </ul>
                    </li>
                </ul>
                <div class="form__politics block_margin">
                    <input id="agreement" class="form__box" type="checkbox" name="agreement" hidden>
                    <label class="box__label" for="agreement"></label>
                    <span class="politics__content">
                        Я согласен на обработку моих персональных
                        данных в соответствии с Политикой и
                        Пользовательским соглашением
                    </span>
                </div>
                <button class="form__button">Сохранить</button>
            </form>
        </main>
    </div>
    <!-- Плагин для маски ввода данных-->
    <script type="text/javascript" src="{{ url_for('static', path='js/inputmask.js') }}"></script>
    <!-- Фильтрация для текстового поля 'часовой пояс'-->
    <script type="text/javascript" src="{{ url_for('static', path='js/update_selector.js') }}"></script>
    <script>

        /* Инициализация маски для полей: имя, дата */

        IMask(document.querySelector("#full-name"), {
            mask: "[" + "a".repeat(20) + "] [" + "a".repeat(20) + "]"
        })

        const birth_date_mask = IMask(document.querySelector("#birth-date-input"), {
            mask: Date,
            pattern: 'DD.MM.YYYY',
            blocks: {
                YYYY: {
                    mask: IMask.MaskedRange,
                    from: 1900,
                    to: 9999
                },
                MM: {
                    mask: IMask.MaskedRange,
                    from: 1,
                    to: 12
                },
                DD: {
                    mask: IMask.MaskedRange,
                    from: 1,
                    to: 31
                },
            }
        })

        /* Создание календаря */

        const date = document.querySelector("#birth-date")
        const date_input = document.querySelector("#birth-date-input")

        document.ontouchend = () => {
            date.blur()
        }
        document.onclick = () => {
            date.blur()
        }

        date.onchange = () => {
            let [year, month, day] = date.value.split("-")
            date_input.value = `${day}.${month}.${year}`
            birth_date_mask.updateValue()
        }

        date_input.onchange = () => {
            let [day, month, year] = date_input.value.split(".")
            date.value = `${year}-${month}-${day}`
        }

        /* Отправка данных из формы */

        const App = window.Telegram.WebApp;
        const api_url = "{{ host }}"

        let [first_name, last_name] = [App.initDataUnsafe.user.first_name, App.initDataUnsafe.user.last_name]
        document.querySelector("#full-name").value = `${first_name} ${last_name}`;

        async function postUser() {
            let url = `${api_url}api/user/`;
            let timezone = document.querySelector("#time-zone").value
            let account_id = App.initDataUnsafe.user.id
            let user = {
                id: account_id,
                name: document.querySelector("#full-name").value,
                birthdate: document.querySelector("#birth-date").value,
                timezone: timezone ? timezone !== "" : 0,
            };

            await fetch(url, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'ngrok-skip-browser-warning': '100',
                    'Content-Type': 'application/json',
                    'accept': 'application/json',
                    'Authorization': btoa(App.initData),
                },
                body: JSON.stringify(user),
            }).then(res => {
                App.close()
            }).catch(err => {
                App.alert("error")
            })
        }

    </script>
</body>
</html>
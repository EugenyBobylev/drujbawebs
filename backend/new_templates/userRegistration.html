<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="registration.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .birthday{
            text-align: left;
        }
        a{
            text-decoration: none;
            cursor: pointer !important;
        }
    </style>
</head>
<body>
    <div id="container">

        <img src="./women.png" alt="">
        <h1>Регистрация</h1>
        <p>Пожалуйста, введите данные для регистрации. После этого вы сможете начать сбор</p>
        <form action="#" class="register__form" name="userRegistrationForm">
            <input id="uname" type="text" placeholder="Имя и фамилия" class="required" name="name" required>
            <div class="dateInput">
                <input  type="date" onchange="this.nextElementSibling.innerHTML = !this.value ? 'Дата рождения' : this.value.split('-')[2]+'.'+this.value.split('-')[1]+'.'+this.value.split('-')[0]" id="birthday" name="birthday" required>
                <label for="birthday">Дата рождения</label>
            </div>
            <select class="timezone" name="timezone" id="timezone">
                <option value=-12> (GMT -12:00) Эниветок, Кваджалейн </option>
                <option value=-11> (GMT -11:00) Остров Мидуэй, Самоа </option>
                <option value=-10> (GMT -10:00) Гавайи </option>
                <option value=-9> (GMT -9:00) Аляска </option>
                <option value=-8> (GMT -8:00) Тихоокеанское время (США и Канада) </option>
                <option value=-7> (GMT -7:00) Горное время (США и Канада) </option>
                <option value=-6> (GMT -6:00) Центральное время (США и Канада), Мехико</option>
                <option value=-5> (GMT -5:00) Восточное время (США и Канада), Богота, Лима </option>
                <option value=-4> (GMT -4:00) Атлантическое время (Канада), Каракас, Ла-Пас </option>
                <option value=-3> (GMT -3:30) Ньюфаундленд </option>
                <option value=-3> (GMT -3:00) Бразилия, Буэнос-Айрес, Джорджтаун </option>
                <option value=-2> (GMT -2:00) Срединно-Атлантического </option>
                <option value=-1> (GMT -1:00 час) Азорские острова, острова Зеленого Мыса </option>
                <option value=0> (GMT) Время Западной Европе, Лондон, Лиссабон, Касабланка </option>
                <option value=1> (GMT +1:00 час) Брюссель, Копенгаген, Мадрид, Париж </option>
                <option value=2> (GMT +2:00) Киев, Калининград, Южная Африка </option>
                <option value=3 selected> (GMT +3:00) Багдад, Эр-Рияд, Москва, Санкт-Петербург</option>
                <option value=4> (GMT +4:00) Абу-Даби, Мускат, Баку, Тбилиси</option>
                <option value=5> (GMT +5:00) Екатеринбург, Исламабад, Карачи, Ташкент</option>
                <option value=6> (GMT +6:00) Алматы, Дакке, Коломбо </option>
                <option value=7> (GMT +7:00) Бангкок, Ханой, Джакарта</option>
                <option value=8> (GMT +8:00) Пекин, Перт, Сингапур, Гонконг</option>
                <option value=9> (GMT +9:00) Токио, Сеул, Осака, Саппоро, Якутск</option>
                <option value=10> (GMT +10:00) Восточная Австралия, Гуам, Владивосток </option>
                <option value=11> (GMT +11:00) Магадан, Соломоновы острова, Новая Каледония</option>
                <option value=12> (GMT +12:00) Окленд, Веллингтон, Фиджи, Камчатка</option>
            </select>
            <div class="formFooter">
                <input type="checkbox" name="check" id="" required>
                <label for="">Я согласен на обработку моих персональных данных в соответствии с <a href="https://druzhba.io/privacy">Политикой</a> и <a href="https://druzhba.io/user-agreement">Пользовательским</a> соглашением</label>
                    <a  href="./feeCreation.html">
                        <button type="submit" onclick="postUser()">
                            Сохранить
                            </button>
                    </a>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).on('click','a', function(event){
            event.preventDefault()
            var url = $(this).attr('href');
            $('#container').load(url)
        })
    </script>
    <script>
        document.getElementById("birthday").style.transform = "scaleX(" + (document.getElementById("birthday").nextElementSibling.offsetWidth) + ")"
        let timeSelect = document.getElementById("timezone")
        const date = new Date();
        const offset = date.getTimezoneOffset()/ 60 * -1;
        // let timeOption = document.querySelector('option[value="'+(offset).toFixed(1)+'"]').selected = true;
        // document.getElementById("timeZoneInput").value = "Часовой пояс: " + Intl.DateTimeFormat().resolvedOptions().timeZone
    </script>
    <script>
        let tg = window.Telegram.WebApp;  //получаем объект webapp
        tg.MainButton.text = "Сохранить"; //изменяем текст кнопки
        tg.MainButton.show();
        tg.MainButton.enable();
        Telegram.WebApp.onEvent("mainButtonClicked", postUser);

        let user_name = `${tg.initDataUnsafe.user.first_name} ${tg.initDataUnsafe.user.last_name}`
        document.getElementById("uname").value = user_name;
        // let api_url = "{{host}}";
        // console.log(api_url);
        async function postUser(){
            let url = `https://panel.druzhba.io/api/user/`;

            // вывести отладочное сообещние
            // msg = `user_id=${tg.initDataUnsafe.user.id}`
            // if(tg.initData !== '')
            //      Telegram.WebApp.showAlert(msg);

            // создать пользователя
            let user = {
                id: tg.initDataUnsafe.user.id,
                name: document.getElementById("uname").value,
                birthdate: document.getElementById("birthday").value,
                timezone: document.getElementById("timezone").value,
            };
            // подготовить к отправке и отправить запрос на server
            let body = JSON.stringify(user);

            let response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'ngrok-skip-browser-warning': '100',
                    'Content-Type': 'application/json',
                    'accept': 'application/json',
                    'Authorization': btoa(tg.initData),
                },
                body: body,
            });
            console.info(response.status)
        }
    </script>
    <script src="./js/api.js"></script>
    <script src="./js/userRegister.js"></script>
</body>
</html>

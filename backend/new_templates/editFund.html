<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/feeCreation.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Изменение сбора</title>
</head>
<body>
    <div class="container">
        <main class="app">
            <div class="wrapper">
                <img src="{{ url_for('static', path='/img/backgrounds/blur-back-2.png') }}" alt="">
            </div>
            <div class="app__info block_margin">
                <div class="info__title info__title_margin">
                    <h3>Изменение сбора</h3>
                </div>
                <div class="info__content">
                    Пожалуйста, заполните данные о сборе
                </div>
            </div>
            <form class="app__form" onsubmit="sendData(event)">
                <ul class="form__blocks block_margin">
                    <li class="form__item form__item_margin">
                        <input id="reason" name="reason" class="form__field" type="text" placeholder=" " required>
                        <label for="reason" class="field__placeholder">Тип события</label>
                    </li>
                    <li class="form__item form__item_margin">
                        <input id="target" name="target" class="form__field" type="text" placeholder=" " required>
                        <label for="target" class="field__placeholder">Кому собираем</label>
                    </li>
                    <li class="form__item form__item_margin">
                        <input id="event-date-input" class="form__field" type="text" placeholder=" " required>
                        <label for="event-date-input" class="field__placeholder">Дата события</label>
                        <input id="event-date" class="form__date" type="date" name="event-date">
                    </li>
                    <li class="form__item">
                        <input id="transfer-info" name="transfer_info" class="form__field" type="text" placeholder=" " required>
                        <label for="transfer-info" class="field__placeholder field__placeholder_s-font">Ссылка на внешнюю копилку/карту</label>
                    </li>
                    <ul class="form__item-list">
                        <span class="item-list__span item-list__span_margin">Ссылки на желаемый подарок</span>
                        <li class="form__item form__item_link form__item_margin">
                            <input id="gift-info" class="form__field" name='gift_info' type="text" placeholder=" ">
                            <label for="gift-info" class="field__placeholder">Введите ссылку</label>
                            <span class="item__button item__button_add"></span>
                        </li>
                    </ul>
                </ul>
                <div class="form__party-block form__party-block_margin">
                    <input id="add-info" class="form__box" type="checkbox" hidden>
                    <label class="box__label" for="add-info"></label>
                    <span class="box__span">
                        Добавить данные о праздновании
                    </span>
                    <ul class="party-block__wrapper">
                        <li class="form__item party-block__item form__item_margin">
                            <input id="congratulation-date-input" class="form__field" type="text" placeholder=" ">
                            <label for="congratulation-date-input" class="field__placeholder">Дата события</label>
                            <input id="congratulation-date" type="date" class="form__date"  name="congratulation_date">
                        </li>
                        <li class="form__item party-block__item form__item_margin">
                            <input id="congratulation-time" name="congratulation_time" class="form__field" type="text" placeholder=" ">
                            <label for="congratulation-time" class="field__placeholder">Время</label>
                        </li>
                        <li class="form__item party-block__item form__item_margin">
                            <input id="event-place" name="event_place" class="form__field" type="text" placeholder=" ">
                            <label for="event-place" class="field__placeholder">Ссылка на место празднования</label>
                        </li>
                        <li class="form__item party-block__item">
                            <input id="event-dresscode" name="event_dresscode" class="form__field" type="text" placeholder=" ">
                            <label for="event-dresscode" class="field__placeholder">Дресс-код</label>
                        </li>
                    </ul>
                </div>
                <div class="form__footer">
                    <span class="form__cancel">Отмена</span>
                    <button class="form__button">Изменить</button>
                </div>
            </form>
        </main>
    </div>
    <script type="text/javascript" src="{{ url_for('static', path='/js/inputmask.js') }}"></script>
    <script>

        /* Создание валидации полей */

        ["#event-date", "#congratulation-date"].forEach((_id) => {
            let date = document.querySelector(_id)
            let date_input = document.querySelector(_id + "-input")

            date.mask = IMask(date_input, {
                mask: Date,
                pattern: 'DD.MM.YYYY',
                blocks: {
                    YYYY: {
                        mask: IMask.MaskedRange,
                        from: 1900,
                        to: 9999
                    },
                    MM: {
                        mask: IMask.MaskedRange,
                        from: 1,
                        to: 12
                    },
                    DD: {
                        mask: IMask.MaskedRange,
                        from: 1,
                        to: 31
                    },
                }
            })
            document.ontouchend = () => {
                date.blur()
            }
            document.onclick = () => {
                date.blur()
            }

            date.onfocus = () => {
                date.style.opacity = 0
            }

            date.onblur = () => {
                date.style.opacity = 1
            }

            date.onchange = () => {
                let [year, month, day] = date.value.split("-")
                date_input.value = `${day}.${month}.${year}`
            }

            date_input.onchange = () => {
                let [day, month, year] = date_input.value.split(".")
                date.value = `${year}-${month}-${day}`
            }
        })
        const time = document.querySelector("#congratulation-time")
        time.mask = IMask(document.querySelector("#congratulation-time"), {
            mask: Date,
            pattern: 'HH:MM',
            blocks: {
                HH: {
                    mask: IMask.MaskedRange,
                    from: 0,
                    to: 23
                },
                MM: {
                    mask: IMask.MaskedRange,
                    from: 0,
                    to: 590
                }
            }
        })

        /* Создание добавляющихся ссылок */

        var mainItem = init_add_button(document.querySelector(".item__button_add"))
        const item_list = document.querySelector(".form__item-list")

        function init_add_button(button) {
            let item = button.parentElement

            button.onclick = () => {
                let new_item = button.parentElement.cloneNode(true)

                init_remove_button(button)
                init_add_button(new_item.querySelector(".item__button"))
                item_list.appendChild(new_item)

                let _id = `gift-${item_list.length}`
                new_item.querySelector(".form__field").value = ""
                new_item.querySelector(".form__field").id = _id

                new_item.querySelector(".field__placeholder").innerText = "Дополнительная ссылка"
                new_item.querySelector(".field__placeholder").for = _id
                mainItem = new_item
            }
            return item
        }

        function init_remove_button(button) {
            button.classList.remove("item__button_add")
            button.classList.add("item__button_remove")
            button.onclick = () => {
                item_list.removeChild(button.parentElement)
            }
        }

        /* Автокомплит */

        function create_links(data_array) {
            for(let key in data_array) {
                if (key != 0) {
                    mainItem.querySelector(".item__button").click()
                }
                mainItem.querySelector(".form__field").value = data_array[key]
            }

        }

        function auto_complete(data_array) {
            data_array.forEach((data_item) => {
                let [_id, data] = data_item
                let input = document.querySelector(_id)
                if (data !== '') {
                    input.value = data
                    if (_id.includes("date")) {
                        input.onchange()
                    }
                    if (input.mask) {
                        input.mask.updateValue()
                    }
                }
            })
        }
        auto_complete([
            ["#reason", '{{ reason }}'],
            ["#target", '{{ target }}'],
            ["#event-date", '{{ event_date }}'],
            ["#transfer-info", '{{ transfer_info }}']
        ])
        create_links(JSON.parse({{ gift_info | tojson }}))

        if ('{{ congratulation_date }}' || '{{ congratulation_time }}' || '{{ event_place }}' || '{{ event_dresscode }}') {
            document.querySelector("#add-info").checked = true
            auto_complete([
                ["#congratulation-date", '{{ congratulation_date }}'],
                ["#congratulation-time", '{{ congratulation_time }}'],
                ["#event-place", '{{ event_place }}'],
                ["#event-dresscode", '{{ event_dresscode }}']
            ])
        }

        /* Отправка формы */

        let App = window.Telegram.WebApp;


        document.querySelector(".form__cancel").onclick = () => {
            App.close()
        }

        let api_url = "{{host}}";
        let fund_id = "{{fund_id}}";


        //let user_name = `${tg.initDataUnsafe.user.first_name} ${tg.initDataUnsafe.user.last_name}`

        async function postFund() {
            // let user_id = tg.initDataUnsafe.user.id;
            let url = `${api_url}api/fundraising/${fund_id}/`;

            // создать сбор (fundraising)
            let congratulations_date = document.getElementById("congratulation-date").value;
            if (congratulations_date === "")
                congratulations_date = null;

            let congratulations_time = document.getElementById("congratulation-time").value;
            if (congratulations_time === "")
                congratulations_time = null;

            let fund = {
                reason: document.getElementById("reason").value,
                target: document.getElementById("target").value,
                start: new Date().toJSON().slice(0, 10),
                event_date: document.getElementById("event-date").value,
                transfer_info: document.getElementById("transfer-info").value,
                gift_info: create_gift_info_data(),
                congratulation_date: congratulations_date,
                congratulation_time: congratulations_time,
                event_place: document.getElementById("event-place").value,
                event_dresscode: document.getElementById("event-dresscode").value,
            };

            let body = JSON.stringify(fund);
            // Отладочное сообщение
            // tg.showAlert(fund.reason);
            // alert(body);

            await fetch(url, {
                method: 'PUT',
                mode: 'cors',
                headers: {
                    'ngrok-skip-browser-warning': '100',
                    'Content-Type': 'application/json',
                    'accept': 'application/json',
                    'Authorization': btoa(App.initData),
                },
                body: body,
            }).then(res => {
                App.close()
            }).catch(err => {
                App.alert("error")
            })
        }

        function create_gift_info_data() {
            let data = {}
            item_list.querySelectorAll(".form__field").forEach((input, index) => {
                data[`${index}`] = input.value
            })
            return JSON.stringify(data)
        }

        function sendData(event) {
            event.preventDefault()
            postFund()
            return true
        }

    </script>
</body>
</html>